name: Build master

on:
  push:
    branches:
      - "master"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKERHUB_REPO: ethpandaops/slashoor

jobs:
  check:
    name: Run code checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Check go fmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -s -l .
            exit 1
          fi

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        run: staticcheck ./...

      - name: Run tests
        run: go test -race -vet=off ./...

  build-linux-amd64:
    name: Build linux/amd64 binary
    needs: [check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Build binary
        run: |
          mkdir -p bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s -X github.com/slashoor/slashoor/cmd.Version=master -X github.com/slashoor/slashoor/cmd.GitCommit=${{ github.sha }}" \
            -o bin/slashoor .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slashoor_linux_amd64
          path: bin/slashoor

  build-linux-arm64:
    name: Build linux/arm64 binary
    needs: [check]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Build binary
        run: |
          mkdir -p bin
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
            -ldflags="-w -s -X github.com/slashoor/slashoor/cmd.Version=master -X github.com/slashoor/slashoor/cmd.GitCommit=${{ github.sha }}" \
            -o bin/slashoor .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slashoor_linux_arm64
          path: bin/slashoor

  build-docker-amd64:
    name: Build amd64 docker image
    needs: [build-linux-amd64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: slashoor_linux_amd64
          path: bin

      - name: Prepare binary
        run: chmod +x bin/slashoor

      - name: Build and push amd64 image
        run: |
          docker build . --file Dockerfile-stub \
            --tag ${{ env.DOCKERHUB_REPO }}:master-amd64 \
            --tag ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-amd64 \
            --platform=linux/amd64
          docker push ${{ env.DOCKERHUB_REPO }}:master-amd64
          docker push ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-amd64

  build-docker-arm64:
    name: Build arm64 docker image
    needs: [build-linux-arm64]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: slashoor_linux_arm64
          path: bin

      - name: Prepare binary
        run: chmod +x bin/slashoor

      - name: Build and push arm64 image
        run: |
          docker build . --file Dockerfile-stub \
            --tag ${{ env.DOCKERHUB_REPO }}:master-arm64 \
            --tag ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-arm64 \
            --platform=linux/arm64
          docker push ${{ env.DOCKERHUB_REPO }}:master-arm64
          docker push ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-arm64

  build-multiarch-manifest:
    name: Build multiarch docker manifest
    needs: [build-docker-amd64, build-docker-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push multiarch manifests
        run: |
          # Create manifest for master-<sha>
          docker manifest create ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }} \
            --amend ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-amd64 \
            --amend ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-arm64
          docker manifest push ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}

          # Create manifest for master
          docker manifest create ${{ env.DOCKERHUB_REPO }}:master \
            --amend ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-amd64 \
            --amend ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-arm64
          docker manifest push ${{ env.DOCKERHUB_REPO }}:master

          # Create manifest for master-latest
          docker manifest create ${{ env.DOCKERHUB_REPO }}:master-latest \
            --amend ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-amd64 \
            --amend ${{ env.DOCKERHUB_REPO }}:master-${{ steps.vars.outputs.sha_short }}-arm64
          docker manifest push ${{ env.DOCKERHUB_REPO }}:master-latest
