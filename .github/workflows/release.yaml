name: Build Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version Number (e.g., '0.1.0')"
        required: true

env:
  DOCKERHUB_REPO: ethpandaops/slashoor

permissions:
  contents: write

jobs:
  check:
    name: Run code checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Check go fmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -s -l .
            exit 1
          fi

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        run: staticcheck ./...

      - name: Run tests
        run: go test -race -vet=off ./...

  build-linux-amd64:
    name: Build linux/amd64 binary
    needs: [check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Build binary
        run: |
          mkdir -p bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s -X github.com/slashoor/slashoor/cmd.Version=v${{ inputs.version }} -X github.com/slashoor/slashoor/cmd.GitCommit=${{ github.sha }}" \
            -o bin/slashoor .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slashoor_linux_amd64
          path: bin/slashoor

  build-linux-arm64:
    name: Build linux/arm64 binary
    needs: [check]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Build binary
        run: |
          mkdir -p bin
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
            -ldflags="-w -s -X github.com/slashoor/slashoor/cmd.Version=v${{ inputs.version }} -X github.com/slashoor/slashoor/cmd.GitCommit=${{ github.sha }}" \
            -o bin/slashoor .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slashoor_linux_arm64
          path: bin/slashoor

  build-docker-amd64:
    name: Build amd64 docker image
    needs: [build-linux-amd64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: slashoor_linux_amd64
          path: bin

      - name: Prepare binary
        run: chmod +x bin/slashoor

      - name: Build and push amd64 image
        run: |
          docker build . --file Dockerfile-stub \
            --tag ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-amd64 \
            --platform=linux/amd64
          docker push ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-amd64

  build-docker-arm64:
    name: Build arm64 docker image
    needs: [build-linux-arm64]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: slashoor_linux_arm64
          path: bin

      - name: Prepare binary
        run: chmod +x bin/slashoor

      - name: Build and push arm64 image
        run: |
          docker build . --file Dockerfile-stub \
            --tag ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-arm64 \
            --platform=linux/arm64
          docker push ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-arm64

  build-multiarch-manifest:
    name: Build multiarch docker manifest
    needs: [build-docker-amd64, build-docker-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push multiarch manifests
        run: |
          # Create manifest for v<version>
          docker manifest create ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }} \
            --amend ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-amd64 \
            --amend ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-arm64
          docker manifest push ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}

          # Create manifest for latest
          docker manifest create ${{ env.DOCKERHUB_REPO }}:latest \
            --amend ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-amd64 \
            --amend ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}-arm64
          docker manifest push ${{ env.DOCKERHUB_REPO }}:latest

  create-release:
    name: Create GitHub Release
    needs: [build-multiarch-manifest]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: slashoor_linux_amd64
          path: slashoor_linux_amd64

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: slashoor_linux_arm64
          path: slashoor_linux_arm64

      - name: Create release archives
        run: |
          cd slashoor_linux_amd64 && tar -czf ../slashoor_${{ inputs.version }}_linux_amd64.tar.gz slashoor && cd ..
          cd slashoor_linux_arm64 && tar -czf ../slashoor_${{ inputs.version }}_linux_arm64.tar.gz slashoor && cd ..

      - name: Generate changelog
        id: changelog
        run: |
          git fetch --tags
          prev_tag=$(git tag --sort=-version:refname | grep -e "^v[0-9.]*$" | head -n 1)
          echo "previous release: $prev_tag"
          if [ "$prev_tag" ]; then
            changelog=$(git log --oneline --no-decorate $prev_tag..HEAD)
          else
            changelog=$(git log --oneline --no-decorate)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          draft: false
          prerelease: false
          files: |
            slashoor_${{ inputs.version }}_linux_amd64.tar.gz
            slashoor_${{ inputs.version }}_linux_arm64.tar.gz
          body: |
            ## What's Changed
            ${{ steps.changelog.outputs.changelog }}

            ## Docker Image
            ```bash
            docker pull ${{ env.DOCKERHUB_REPO }}:v${{ inputs.version }}
            ```

            ## Release Artifacts
            | File | Platform |
            |------|----------|
            | slashoor_${{ inputs.version }}_linux_amd64.tar.gz | Linux x86_64 |
            | slashoor_${{ inputs.version }}_linux_arm64.tar.gz | Linux ARM64 |
